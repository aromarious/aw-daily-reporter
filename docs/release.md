# リリースプロセス

このドキュメントは、aw-daily-reporter のリリースプロセス全体を説明します。

## 目次

- [バージョニング戦略](#バージョニング戦略)
- [リリースフロー](#リリースフロー)
- [リリース判断基準](#リリース判断基準)
- [リリース手順](#リリース手順)
- [リリース後の作業](#リリース後の作業)
- [トラブルシューティング](#トラブルシューティング)

## バージョニング戦略

このプロジェクトは **セマンティックバージョニング（SemVer）** に従います。

### バージョン形式

```
v<MAJOR>.<MINOR>.<PATCH>
```

例: `v0.2.3`, `v1.0.0`, `v2.1.4`

### バージョン番号の更新ルール

- **MAJOR (メジャーバージョン)**: 後方互換性のない変更
  - APIの破壊的変更
  - 設定ファイル形式の非互換な変更
  - データベーススキーマの非互換な変更

- **MINOR (マイナーバージョン)**: 後方互換性のある機能追加
  - 新機能の追加
  - 既存機能の拡張
  - 非推奨機能のマーク（削除はしない）

- **PATCH (パッチバージョン)**: 後方互換性のあるバグ修正
  - バグ修正
  - パフォーマンス改善
  - ドキュメント修正
  - 依存関係の更新（セキュリティパッチ）

### バージョン 0.x.x について

メジャーバージョンが 0 の間は、開発初期段階とみなされ、以下のルールが適用されます：

- **0.MINOR.PATCH**: MINOR の変更で破壊的変更を含む可能性がある
- **1.0.0**: 最初の安定版リリース

## リリースフロー

### ブランチ戦略

このプロジェクトは **Gitflow** を採用しています。

```
main ──────●─────●─────●───── (リリース時のみ更新)
           v0.1.0  v0.2.0  v0.3.0
            ↑      ↑      ↑
develop ────●──●───●──●───●──●── (日々の開発)
            │  │   │  │   │  │
feature/*   └──┘   └──┘   └──┘
```

### リリースプロセスの流れ

1. **開発**: `feature/*` ブランチで機能開発
2. **統合**: `develop` ブランチにマージ
3. **テスト**: `develop` ブランチでテスト・検証
4. **リリース準備**: バージョン番号の更新、リリースノートの準備
5. **タグ作成**: `develop` から `v*` タグを作成
6. **自動ビルド**: GitHub Actions がビルド・リリース作成
7. **main へマージ**: リリース後、`develop` を `main` にマージ

## リリース判断基準

### リリースタイミング

以下の条件を満たしたときにリリースを検討します：

- ✅ すべてのテストが通過している
- ✅ 重大なバグが残っていない
- ✅ リリースする機能が完成している
- ✅ ドキュメントが更新されている
- ✅ セキュリティ脆弱性が修正されている

### リリース頻度

- **パッチリリース**: 必要に応じて（バグ修正、セキュリティパッチ）
- **マイナーリリース**: 機能がまとまったタイミング（1-2週間程度）
- **メジャーリリース**: 大きな変更がある場合（数ヶ月単位）

## リリース手順

### 1. 事前準備

#### バージョン番号の決定

変更内容を確認し、セマンティックバージョニングに従ってバージョン番号を決定します。

```bash
# 前回リリースからの変更を確認
git log $(git describe --tags --abbrev=0)..HEAD --oneline
```

#### バージョン番号の更新

以下のファイルのバージョン番号を更新します：

- `pyproject.toml`
- `package.json`

```bash
# pyproject.toml
version = "0.2.3"

# package.json
"version": "0.2.3"
```

変更をコミット：

```bash
git add pyproject.toml package.json
git commit -m "chore: bump version to 0.2.3"
```

### 2. タグ作成とリリース

`/release-tag` スキルを使用します。詳細な手順は [.claude/skills/release-tag/SKILL.md](../.claude/skills/release-tag/SKILL.md) を参照してください。

```bash
# スキルを実行
/release-tag
```

または、手動で実行する場合：

```bash
# タグ作成
git tag -a v0.2.3 -m "Release v0.2.3"

# タグをプッシュ
git push origin v0.2.3

# GitHub Actions が自動的にリリースを作成
```

### 3. リリースノートの編集

GitHub Actions が自動的に生成したリリースを確認し、必要に応じて編集します。

```bash
# リリースを確認
gh release view v0.2.3

# 編集（必要に応じて）
gh release edit v0.2.3
```

### 4. main ブランチへのマージ

リリース後、`develop` を `main` にマージします。

```bash
/merge-to-main
```

## リリース後の作業

### 1. リリースの確認

- [ ] リリースページが正しく表示されているか確認
- [ ] ビルド成果物（.whl, .tar.gz）がアップロードされているか確認
- [ ] リリースノートが適切に記載されているか確認

### 2. ドキュメントの更新（必要に応じて）

- [ ] README.md のバージョン情報を更新
- [ ] インストール手順を確認
- [ ] 変更履歴（CHANGELOG.md）を更新（将来的に作成予定）

### 3. アナウンス（必要に応じて）

- [ ] プロジェクトのユーザーに通知
- [ ] ブログ記事の投稿（メジャーリリースの場合）
- [ ] SNS での告知

### 4. 次のバージョンの準備

- [ ] GitHub Project で次のマイルストーンを設定
- [ ] 次のバージョンで対応する Issue を整理

## トラブルシューティング

### 重複リリースが作成された

**問題**: 同じタグに対して複数のリリースが作成された（1つは正常、もう1つは `untagged-...`）

**原因**: GitHubでは1つのタグに対して1つのリリースしか関連付けられないため、既に使用されているタグに対して新しいリリースを作成しようとすると、自動的に一時的なタグが割り当てられます。

**解決方法**:

詳細は [.claude/skills/release-tag/SKILL.md#トラブルシューティング](../.claude/skills/release-tag/SKILL.md#トラブルシューティング) を参照してください。

### GitHub Actions が失敗した

**問題**: タグをプッシュしたが、GitHub Actions のビルドが失敗した

**確認事項**:

1. ワークフローの実行ログを確認
   ```bash
   gh run list --workflow=ci.yml --limit 5
   gh run view <RUN_ID> --log-failed
   ```

2. よくある原因:
   - テストの失敗
   - ビルドの失敗
   - 依存関係の問題

**解決方法**:

1. 問題を修正
2. 新しいコミットを作成
3. タグを削除して再作成
   ```bash
   # ローカルタグを削除
   git tag -d v0.2.3

   # リモートタグを削除
   git push origin :refs/tags/v0.2.3

   # 新しいタグを作成
   git tag -a v0.2.3 -m "Release v0.2.3"
   git push origin v0.2.3
   ```

### バージョン番号を間違えた

**問題**: タグを作成した後にバージョン番号の間違いに気づいた

**解決方法**:

リリースが公開される前（数分以内）であれば：

1. タグとリリースを削除
   ```bash
   # リリースを削除
   gh release delete v0.2.3 --yes

   # タグを削除
   git tag -d v0.2.3
   git push origin :refs/tags/v0.2.3
   ```

2. 正しいバージョン番号で再作成

リリースが既に公開されている場合：

- パッチバージョンを上げて新しいリリースを作成することを推奨
- 削除は避ける（ユーザーが既にダウンロードしている可能性があるため）

## 参考資料

- [セマンティックバージョニング 2.0.0](https://semver.org/lang/ja/)
- [Gitflow ワークフロー](https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow)
- [GitHub Releases ドキュメント](https://docs.github.com/ja/repositories/releasing-projects-on-github)
- [Conventional Commits](https://www.conventionalcommits.org/ja/v1.0.0/)
