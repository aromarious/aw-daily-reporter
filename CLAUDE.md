# aw-daily-reporter コーディングガイドライン

このドキュメントは、aw-daily-reporter プロジェクトにおけるコーディング規約、ワークフロー、ベストプラクティスを定義します。

## 目次

- [グローバルポリシー](#グローバルポリシー)
- [ロードマップ連携](#ロードマップ連携)
- [言語別規約](#言語別規約)
  - [TypeScript/React/Next.js](#typescriptreactnextjs)
  - [Python](#python)
- [テスト標準](#テスト標準)
- [Git & PR ワークフロー](#git--pr-ワークフロー)
- [Markdown スタイルガイド](#markdown-スタイルガイド)
- [利用可能なスキル](#利用可能なスキル)

## グローバルポリシー

### 日本語コメント必須

すべてのコードコメントおよびドキュメントは日本語で記述すること。

### 国際化（i18n）

ユーザー向けの文字列はすべて国際化対応すること。

- **TypeScript**: `useTranslation()` から `@/contexts/I18nContext` をインポートし、`t('English Text')` で文字列をラップする。英語テキストをキーとして使用し、`src/locales/ja.json` に日本語翻訳を追加すること。
- **Python**: `_()` を `aw_daily_reporter.shared.i18n` からインポートし、すべてのユーザー向け文字列（ログ、UI、レポート）をラップする。

**新しい文字列を追加する場合**:

- TypeScript: 必ず `src/locales/ja.json` に日本語翻訳を追加すること
- Python: 対応する翻訳ファイルに日本語翻訳を追加すること

### ルートディレクトリ管理

プロジェクトルート直下にファイルを配置することは極力避けること。新しくファイルを配置する必要がある場合は、必ずユーザーに許可を得ること。

### パッケージマネージャ

**pnpm のみを使用すること。**

- `npm` は使用しない
- `npx` も使用しない

## ロードマップ連携

新しいメジャータスクや機能開発を開始する前に、プロジェクトルートの `ROADMAP.md` を確認し、現在のプロジェクト優先度と計画されたタスクを理解すること。

ユーザーのリクエストがロードマップ内の項目と一致する場合は、それを言及し、作業の進捗に応じてロードマップのステータスを更新すること。

## 言語別規約

### TypeScript/React/Next.js

#### フレームワーク & 構成

- **Next.js**: Next.js App Router 構造を使用する。
- **コンポーネント配置**: コンポーネントは `src/app`（ページ/レイアウト）または `src/components`（再利用可能な UI）に配置する。

#### スタイリング

- **Tailwind CSS + DaisyUI**: ユーティリティクラスと DaisyUI コンポーネントを使用する。
- **セマンティクス**: 可能な限りセマンティックなクラス名（例: `btn btn-primary`）を優先し、長いユーティリティクラスのチェーンは避ける。

#### ユーザー通知

- **Toast**: すべてのユーザー向けメッセージには Toast 通知を使用する。
- **適切なレベル**: 各メッセージに対して正しい severity レベル（info、success、warning、error）を使用すること。

#### コンソール出力

- **console.log 禁止**: コードをコミットする前に `console.log` を削除する。
- **エラーハンドリング**: `console.error` は UI 通知（Toast）で処理できない実行時エラーに対してのみ使用する。

#### 型安全性

- **implicit any 禁止**: すべての変数および関数パラメータに明示的な型を付ける。絶対に必要でない限り `any` を避ける。

#### React/Next.js パターン

- **早すぎる最適化を避ける**: 必要になったときに必要なものを作成する。早期の共通化や抽象化は避ける。
- **永続的な状態を最小限に**: 可能な限り状態を持たないようにする。
- **コンポーネントサイズ**: コンポーネントは約150行以内に収める。
- **繰り返しパターン**: ファイル内の繰り返しパターンは、カジュアルにコンポーネントに切り分けてよい。
- **ディレクトリ構成**: ページ構造に沿ったディレクトリ構成を維持する。

### Python

#### ロギング

- **標準**: 詳細なログレベル定義と使用方法については、[ログ標準](docs/logging.md) を参照。
- **print() 禁止**: 本番コードで `print()` ステートメントを使用しない。`logging` モジュールを使用する。
- **スコープ付きログ**: ログメッセージに構造化されたスコープを使用して、フィルタリングを改善する。
  - 形式: `logger.info("[Scope] Message")`
  - 一般的なスコープ:
    - `[Server]`: アプリケーションの起動/シャットダウン
    - `[API]`: ルート処理とリクエスト処理
    - `[Core]`: コアアプリケーションロジック
    - `[Plugin]`: プラグイン実行とライフサイクル
    - `[PERF]`: パフォーマンスメトリクス（必ず `DEBUG` レベル）
- **エラーハンドリング**: 素の `except:` ブロックを残さない。`logger.error(..., exc_info=True)` で例外をログに記録する。

#### 型ヒント

- **明示的な型**: 可能な限り `Any` より具体的な型（`List[str]`、`Dict[str, Any]`、`Optional[int]`）を使用する。
- **戻り値の型**: すべての関数に戻り値の型を定義する。

#### テスト

- **変更時のテスト実行**: ロジックを変更する際は、関連するテストを必ず実行し、完了を報告する前にテストが通ることを確認する。
- **追加時のテスト追加**: 新しいロジックを追加する際は、新機能をカバーする対応するテストを必ず作成する。

## テスト標準

### テスト戦略

- **フロントエンド**: Vitest を使用
- **バックエンド**: Pytest を使用

### 設計パターン

- **AAA パターン**: テストコード内を **Arrange（準備）**、**Act（実行）**、**Assert（検証）** のブロックに明確に分け、コメントで構造を示すこと。

### カバレッジ目標

- **C1（分岐網羅）100%** を目指すこと。

### 境界値分析

判定ロジックに対しては「**On / Off / In**」の3点、あるいは最低限「**On / Off**」の2点を網羅すること。

### 同値分割

正常系（有効同値）だけでなく、異常系（無効同値）の代表値を必ず含めること。

### 独立性の確保

各テストケースは他のテストに依存せず、実行順序を問わず成功するように実装すること。

### モックの適切な使用

外部 API、データベース、ファイルシステムへのアクセスは適切にモック化し、テストの実行速度と再現性を担保すること。

### 命名規則

`test_[対象関数]_[シナリオ]_[期待される結果]` の形式で命名し、テストコード自体を仕様書として読めるようにすること。

## Git & PR ワークフロー

このプロジェクトは **Gitflow ワークフロー**に従います。

### ブランチ戦略

- **main**: 本番用コード（リリース時のみ更新）
- **develop**: 開発用コード（機能追加 PR のターゲット）
- **feature/\***: 新機能開発用（`develop` への PR 元）
- **release/\***: リリース準備用
- **hotfix/\***: 本番環境への緊急修正用

### 開発フロー

1. **作業ブランチの作成**: 実際に開発するのは作業ブランチを作成してそこで実施する。
2. **プルリクエスト（PR）**: ユーザーがプルリクの作成を指示したら `develop` に向けて作成する。
3. **マージ後の処理**: ユーザーが「プルリクマージしました」と言ったら、作業ブランチのローカル・リモート ref を削除する。

### コミット

- **作成タイミング**: コミットを作成してくださいと言うまで、コミットの作成も実行もしない。
- **メッセージ形式**: Conventional Commits (`feat`, `fix`, `docs` など) を使用する。
- **wip コミット**: `feature/*` ブランチでは許可されるが、マージ前にスカッシュする必要がある。

### その他

- `husky` によるプレコミットフックがコミットメッセージのフォーマットを強制する（Conventional Commits）。

## Markdown スタイルガイド

コードフェンスブロックの開始では必ず言語を明記すること。

## 利用可能なスキル

以下のスキルを使用して、一般的な Git およびワークフロータスクを自動化できます。

- **`/start-task`**: 新しく作業を始める時、ブランチとドラフトPRを作成する
- **`/commit`**: 変更をコミットする
- **`/create-pr`**: プルリクエストを作成する
- **`/complete-pr`**: PR をマージし、後処理を実行する
- **`/merge-to-main`**: develop を main ブランチにマージする
- **`/process-dependabot`**: Dependabot PR を処理する
